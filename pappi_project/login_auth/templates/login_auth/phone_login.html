{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4">Вход по номеру телефона</h3>
                    
                    {% if messages %}
                    <div class="messages mb-3">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        {% for field in form %}
                            {% for error in field.errors %}
                                {{ error }}<br>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            {{ error }}<br>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post" action="{% url 'login_auth:phone_login' %}" id="phone-form">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <button type="submit" id="submit-button" class="btn btn-primary w-100 mt-3" disabled>
                            Продолжить
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-primary:disabled {
        background-color: #ccc;
        border-color: #ccc;
        cursor: not-allowed;
    }
    .btn-primary:not(:disabled):hover {
        background-color: #0056b3;
    }
    #id_phone {
        font-size: 1.2em;
        letter-spacing: 0.5px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('id_phone');
    const submitButton = document.getElementById('submit-button');

    // Устанавливаем начальное значение
    if (!phoneInput.value) {
        phoneInput.value = '+7';
    }

    phoneInput.addEventListener('input', function(e) {
        // Удаляем все кроме цифр и +
        let value = this.value.replace(/[^\d+]/g, '');
        
        // Проверяем и корректируем начало номера
        if (!value.startsWith('+7')) {
            if (value.startsWith('8')) {
                value = '+7' + value.substring(1);
            } else if (!value.startsWith('+')) {
                value = '+7' + value;
            }
        }
        
        // Ограничиваем длину
        if (value.length > 12) {
            value = value.substring(0, 12);
        }
        
        this.value = value;
        
        // Активируем/деактивируем кнопку в зависимости от длины номера
        submitButton.disabled = value.length !== 12;
    });

    // Предотвращаем удаление +7
    phoneInput.addEventListener('keydown', function(e) {
        if ((e.key === 'Backspace' || e.key === 'Delete') && 
            (this.value.length <= 2 || 
             this.selectionStart <= 2 || 
             (this.selectionStart === this.selectionEnd && this.selectionStart <= 2))) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %} 